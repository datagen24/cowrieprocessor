# Enrichment Test Harness

Phase 2 introduces an offline-friendly test harness that exercises the new
enrichment stack without hitting external APIs. The harness can operate against
both synthetic fixtures and the archival snapshot at
`/mnt/dshield/data/db/cowrieprocessor.sqlite`.

## Quick Start (Synthetic Data)

```
UV_CACHE_DIR=$(pwd)/tmp/uv-cache uv run pytest \
  tests/integration/test_enrichment_flow.py::test_high_risk_session_full_enrichment
```

This command provisions a temporary SQLite database with high-risk session
fixtures, wires enrichment calls through deterministic stubs, and asserts that
all enrichment flags are raised. No network calls are performed.

## Exercising Failure Modes

To validate graceful degradation paths, use the second harness test:

```
UV_CACHE_DIR=$(pwd)/tmp/uv-cache uv run pytest \
  tests/integration/test_enrichment_flow.py::test_enrichment_graceful_degradation
```

The harness injects empty DShield/URLHaus/SPUR/VirusTotal payloads and verifies
that the pipeline continues with all enrichment flags unset.

## Working With The Real Snapshot

A third test (skipped automatically when the snapshot is unavailable) samples
sessions from `/mnt/dshield/data/db/cowrieprocessor.sqlite` and runs the
enrichment stubs against real world IPs. The harness opens the database in
read-only immutable mode (`mode=ro&immutable=1`) and issues `PRAGMA query_only=1`
so accidental writes cannot occur.

```
UV_CACHE_DIR=$(pwd)/tmp/uv-cache uv run pytest \
  tests/integration/test_enrichment_flow.py::test_real_snapshot_sessions_load_without_network
```

Because the snapshot contains ~39â€¯GB of data, the harness only selects a small
window of session IDs (`LIMIT 3`) and resolves their source IPs by querying the
indexed `raw_events` table. Runtime remains under a second on developer
workstations.

## Custom Stub Responses

`OfflineEnrichmentHarness` accepts a `stubbed_responses` mapping so developers
can inject service-specific payloads:

```python
stubs = {
    "dshield": {"default": {"ip": {"asname": "", "ascountry": ""}}},
    "urlhaus": {"default": ""},
    "spur": {"default": ["" for _ in range(18)]},
    "virustotal": {"default": None},
}

with OfflineEnrichmentHarness(db_path, cache_dir, stubbed_responses=stubs) as harness:
    ...
```

Values can be dictionaries/lists (deep-copied per request), strings, callables
that accept the lookup key, or simple `None`. Exception instances raise inside
the harness, allowing targeted failure injection when needed.

## Safeguards

- All network-facing enrichment helpers (`dshield_query`, `safe_read_uh_data`,
  `read_spur_data`, `vt_query`) are patched before the adapter/service is
  instantiated, ensuring no outbound traffic is attempted.
- Cache files generated by the harness are stored under the caller-provided
  temporary directory so developers can safely inspect or delete them.
- Real snapshot queries use read-only connections; there is no schema migration
  or data mutation.

Refer to `tests/integration/enrichment_harness.py` for extension points.
