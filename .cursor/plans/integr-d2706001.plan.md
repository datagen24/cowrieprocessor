<!-- d2706001-da38-4fb7-ba29-46344af6f92a d78ea405-8695-48d1-8756-61cfa4fa5333 -->
# Integrate Password Intelligence into Longtail Analysis

### Scope

- Add password intelligence as an indicator in `longtail` analysis, using existing enrichment data and opportunistic enrichment for gaps.
- Emit JSON reports (CLI-accessible) summarizing password-related longtail insights; avoid direct Elasticsearch output for this feature.

### Key Integration Points

- Update `cowrieprocessor/threat_detection/longtail.py`:
- Extend `LongtailAnalyzer` to fetch per-session password stats from `SessionSummary.enrichment['password_stats']` and/or `password_*` tables.
- Add optional opportunistic enrichment: when gaps detected, run a bounded, rate-limited password check using `PasswordExtractor` and `HIBPPasswordEnricher`.
- Compute new indicators and fold into `LongtailAnalysisResult.analysis_results`:
- `password_indicator_score` (0–1, weighted by breached prevalence, uniqueness, success rate)
- `breached_attempt_count`, `unique_passwords_count`, `novel_password_hashes_count`
- `sessions_with_breached_credentials`, `top_breached_password_hashes` (hashes only)
- Update `statistical_summary` and `enrichment_coverage` metrics.

- Models/Storage
- Keep DB schema unchanged; store password metrics within `analysis_results` JSON and summary counts in existing numeric fields if needed (e.g., reuse `enrichment_coverage`).

- Opportunistic Enrichment Controls
- Add analyzer params: `enable_password_enrichment`, `max_enrichment_sessions`, `hibp_rate_limit`, `cache_dir`, `status_dir`.
- Respect existing security rules (no logging secrets, hash-only storage, rate limiting).

- CLI Wiring
- `cowrieprocessor/cli/analyze.py` `longtail_analyze`:
- Add flags to toggle password intel and opportunistic enrichment.
- Emit JSON to file/stdout (no ES publish) using existing output path behavior.

- Reporting (JSON-focused)
- `cowrieprocessor/reporting/builders.py`:
- Add optional section in `DailyReportBuilder` for “Password Intelligence Hints” when longtail results are provided.
- Provide lightweight dict with: counts, prevalence bands, sample hashes, session references.
- `cowrieprocessor/cli/report.py`:
- Add flag to include longtail password intel section if available (pull latest longtail run by window).

- Status & Telemetry
- Use `StatusEmitter` phase names `longtail` and `reporting` to record metrics and checkpoints.

### Reporting Artifacts (JSON)

- Longtail run output (file/stdout):
- `password_indicator_score`, counts, top hashed passwords, sessions with breached creds, enrichment coverage, limits applied.
- Daily/weekly report add-on (JSON):
- Aggregated counts per sensor; prevalence histogram; top 10 breached hashes; hint fields for elastic query engine to pivot on.

### Documentation Deliverables (docs/)

- JSON Output Dictionary (consumer-facing):
- `docs/json/password_intelligence_longtail.md`
- Purpose, field definitions, types, units, value ranges, examples.
- Stable JSON Schema in `docs/json/schemas/password_intelligence_longtail.schema.json`.
- Database Dictionary (internal/ORM-facing):
- `docs/db/password_intelligence.md`
- Tables: `password_statistics`, `password_tracking`, `password_session_usage`.
- Columns, types, constraints, indexes, example queries, and data flow from enrichment to longtail.
- Crosswalk:
- `docs/json/db_to_json_crosswalk.md` mapping DB fields to JSON output keys and any transformations.

### Security & Compliance

- Never log cleartext passwords or API keys; only SHA-256 hashes.
- Use rate limiting and k-anonymity HIBP client; sanitize logs; follow StatusEmitter.

### Acceptance

- Feature toggled on via CLI flags and analyzer params; defaults to reuse stored enrichment only.
- Tests cover indicator computation, gap enrichment, bounded behavior, and report content.
- Documentation present and complete; JSON schemas validate example payloads in tests.

### To-dos

- [ ] Extend LongtailAnalyzer with password indicators and enrichment gap checks
- [ ] Add CLI flags to longtail analyze to control password intel and enrichment
- [ ] Add optional password intelligence section to daily/weekly builders
- [ ] Integrate StatusEmitter metrics/checkpoints for longtail password intel
- [ ] Add unit tests for analyzer password indicator computation
- [ ] Add integration tests for opportunistic enrichment and JSON reports